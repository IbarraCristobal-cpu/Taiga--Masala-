<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Gesti√≥n de Productos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --admin-bg: #f4f7fa;
        --admin-panel-bg: #ffffff;
        --admin-text: #333;
        --admin-header: #2c3e50;
        --admin-primary-action: #007bff;
        --admin-secondary-action: #ffc107;
        --admin-success-action: #28a745;
        --admin-danger-action: #dc3545;
        --admin-border: #dee2e6;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--admin-bg);
        color: var(--admin-text);
        margin: 0;
      }
      .admin-navbar {
        background-color: var(--admin-header);
        color: white;
        padding: 0.8em 1.5em;
        font-size: 0.9em;
        font-weight: 500;
      }
      .admin-navbar a {
        color: white;
        text-decoration: none;
        margin: 0 0.5em;
      }
      .admin-main-content {
        background-color: var(--admin-panel-bg);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        max-width: 960px;
        margin: 2em auto;
        padding: 1.5em 2em;
        overflow: hidden;
        min-height: 500px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--admin-border);
        padding-bottom: 1em;
        margin-bottom: 1.5em;
      }
      .page-title {
        font-size: 1.5em;
        margin: 0;
      }

      /* Botones Generales */
      .btn {
        padding: 0.6em 1.2em;
        border: none;
        border-radius: 5px;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.9em;
        transition: opacity 0.2s;
      }
      .btn:hover {
        opacity: 0.9;
      }
      .btn-primary {
        background-color: var(--admin-primary-action);
        color: white;
      }
      .btn-success {
        background-color: var(--admin-success-action);
        color: white;
      }
      .btn-danger {
        background-color: var(--admin-danger-action);
        color: white;
      }
      .btn-warning {
        background-color: var(--admin-secondary-action);
        color: #212529;
      }
      .btn-outline {
        background-color: transparent;
        border: 1px solid var(--admin-primary-action);
        color: var(--admin-primary-action);
      }

      /* Grid de Productos */
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.5em;
        margin-bottom: 2em;
      }
      .product-card {
        border: 1px solid var(--admin-border);
        border-radius: 8px;
        padding: 1em;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background-color: #fdfdfd;
        transition: transform 0.2s;
      }
      .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .product-card img {
        width: 100%;
        height: 120px;
        background-color: #eee;
        border-radius: 5px;
        margin-bottom: 1em;
        object-fit: cover;
      }
      .product-card h4 {
        margin: 0 0 0.2em 0;
        font-size: 1.1em;
      }
      .product-card .stock {
        color: #6c757d;
        margin-bottom: 1em;
        font-size: 0.9em;
      }
      .card-actions {
        display: flex;
        gap: 0.5em;
        margin-top: auto;
      }

      /* Formulario de Edici√≥n/Creaci√≥n */
      .edit-form label {
        font-weight: 500;
        display: block;
        margin-bottom: 0.5em;
        font-size: 0.9em;
        color: #555;
      }
      .edit-form input,
      .edit-form textarea,
      .edit-form select {
        width: 100%;
        padding: 0.8em;
        border: 1px solid var(--admin-border);
        border-radius: 5px;
        font-size: 1em;
        box-sizing: border-box;
        margin-bottom: 1em;
      }
      .form-columns-container {
        display: flex;
        gap: 2em;
        flex-wrap: wrap;
      }
      .form-column {
        flex: 1;
        min-width: 250px;
      }

      .hidden {
        display: none;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--admin-primary-action);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 2em auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <nav class="admin-navbar">
      <a href="B13_B14-Reporte_de_venta.html">Reporte</a> |
      <a href="B15-Moderacion_de_rese√±as.html">Rese√±as</a> |
      <a href="B17-Gestion_de_Productos.html">Gestionar Productos</a>
      <a href="B07-Home.html" style="float: right">Volver al Sitio</a>
    </nav>

    <div class="admin-main-content">
      <!-- VISTA: LISTA DE PRODUCTOS -->
      <div id="product-list-view">
        <div class="page-header">
          <h2 class="page-title">Gesti√≥n de Productos</h2>
          <div style="display: flex; gap: 10px">
            <button id="btn-create-new" class="btn btn-primary">
              + Nuevo Producto
            </button>
            <button id="btn-clean-carts" class="btn btn-outline">
              üßπ Limpiar Carritos
            </button>
          </div>
        </div>

        <div id="loader" class="loader"></div>
        <div id="product-grid" class="product-grid"></div>
      </div>

      <!-- VISTA: FORMULARIO (Crear/Editar) -->
      <div id="product-edit-view" class="hidden">
        <button
          id="back-to-list-btn"
          class="btn btn-outline"
          style="margin-bottom: 1em"
        >
          &larr; Volver
        </button>
        <h2 class="page-title" id="form-title">Editar Producto</h2>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 1em 0" />

        <form id="edit-form" class="edit-form">
          <input type="hidden" id="edit-id" />
          <!-- ID oculto para saber si editamos -->

          <div class="form-columns-container">
            <div class="form-column">
              <label for="edit-name">Nombre del Plato</label>
              <input
                type="text"
                id="edit-name"
                required
                placeholder="Ej: Pollo Tikka Masala"
              />

              <label for="edit-desc">Descripci√≥n</label>
              <textarea
                id="edit-desc"
                rows="5"
                placeholder="Ingredientes y detalles..."
              ></textarea>

              <label for="edit-category">Categor√≠a</label>
              <select id="edit-category">
                <option value="Entradas">Entradas</option>
                <option value="Platos Principales">Platos Principales</option>
                <option value="Postres">Postres</option>
                <option value="Jugos">Jugos</option>
              </select>
            </div>

            <div class="form-column">
              <label for="edit-price">Precio ($)</label>
              <input type="number" id="edit-price" min="0" required />

              <label for="edit-stock">Stock (Unidades)</label>
              <input type="number" id="edit-stock" min="0" required />

              <label for="edit-image">URL de Imagen</label>
              <input
                type="text"
                id="edit-image"
                placeholder="images/Entradas/1.jpg"
              />

              <!-- Previsualizaci√≥n simple -->
              <div style="margin-top: 1em; text-align: center">
                <img
                  id="image-preview"
                  src=""
                  style="max-height: 100px; display: none; border-radius: 5px"
                />
              </div>
            </div>
          </div>

          <div style="margin-top: 2em; text-align: right">
            <button
              type="submit"
              class="btn btn-success"
              style="padding: 0.8em 2em; font-size: 1em"
            >
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // --- REFERENCIAS DOM ---
        const listView = document.getElementById("product-list-view");
        const editView = document.getElementById("product-edit-view");
        const productGrid = document.getElementById("product-grid");
        const loader = document.getElementById("loader");

        // Botones
        const btnCreateNew = document.getElementById("btn-create-new");
        const btnCleanCarts = document.getElementById("btn-clean-carts");
        const btnBack = document.getElementById("back-to-list-btn");

        // Formulario
        const form = document.getElementById("edit-form");
        const formTitle = document.getElementById("form-title");
        const inpId = document.getElementById("edit-id");
        const inpName = document.getElementById("edit-name");
        const inpDesc = document.getElementById("edit-desc");
        const inpPrice = document.getElementById("edit-price");
        const inpStock = document.getElementById("edit-stock");
        const inpCategory = document.getElementById("edit-category");
        const inpImage = document.getElementById("edit-image");
        const imgPreview = document.getElementById("image-preview");

        // --- INICIALIZAR ---
        await loadProducts();

        // --- FUNCIONES L√ìGICAS ---

        // 1. Cargar Productos desde API
        async function loadProducts() {
          loader.style.display = "block";
          productGrid.innerHTML = "";
          try {
            const products = await API.getProducts();
            renderGrid(products);
          } catch (error) {
            alert("Error cargando productos: " + error.message);
          } finally {
            loader.style.display = "none";
          }
        }

        // 2. Renderizar Grid
        function renderGrid(products) {
          if (products.length === 0) {
            productGrid.innerHTML = "<p>No hay productos registrados.</p>";
            return;
          }

          productGrid.innerHTML = products
            .map(
              (p) => `
                <div class="product-card">
                    <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">
                    <h4>${p.name}</h4>
                    <p style="color:#666; font-size:0.85em; margin-bottom:0.5em;">${p.category}</p>
                    <p class="stock">Stock: <b>${p.stock}</b> | $${p.price}</p>
                    <div class="card-actions">
                        <button class="btn btn-warning" onclick="startEdit(${p.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger" onclick="deleteProd(${p.id})">üóëÔ∏è Borrar</button>
                    </div>
                </div>
            `
            )
            .join("");
        }

        // 3. Abrir Formulario (Crear o Editar)
        function showForm(isEdit) {
          listView.classList.add("hidden");
          editView.classList.remove("hidden");
          formTitle.textContent = isEdit ? "Editar Producto" : "Nuevo Producto";

          // Actualizar vista previa de imagen al cambiar URL
          inpImage.oninput = () => {
            if (inpImage.value) {
              imgPreview.src = inpImage.value;
              imgPreview.style.display = "block";
            } else {
              imgPreview.style.display = "none";
            }
          };
        }

        // --- EVENTOS GLOBALES (Botones en tarjetas) ---
        window.startEdit = async (id) => {
          try {
            const product = await API.getProductById(id);
            if (!product) return;

            // Rellenar form
            inpId.value = product.id;
            inpName.value = product.name;
            inpDesc.value = product.description;
            inpPrice.value = product.price;
            inpStock.value = product.stock;
            inpCategory.value = product.category;
            inpImage.value = product.image;

            if (product.image) {
              imgPreview.src = product.image;
              imgPreview.style.display = "block";
            } else {
              imgPreview.style.display = "none";
            }

            showForm(true); // Modo Edici√≥n
          } catch (e) {
            alert(e.message);
          }
        };

        window.deleteProd = async (id) => {
          if (
            confirm(
              "¬øEst√°s seguro de eliminar este producto? Esta acci√≥n no se puede deshacer."
            )
          ) {
            try {
              await API.deleteProduct(id);
              await loadProducts(); // Recargar lista
            } catch (e) {
              alert("Error: " + e.message);
            }
          }
        };

        // --- EVENTOS INTERFAZ ---

        // Bot√≥n Nuevo
        btnCreateNew.addEventListener("click", () => {
          form.reset();
          inpId.value = ""; // ID vac√≠o significa Crear
          imgPreview.style.display = "none";
          showForm(false); // Modo Crear
        });

        // Bot√≥n Volver
        btnBack.addEventListener("click", (e) => {
          e.preventDefault();
          editView.classList.add("hidden");
          listView.classList.remove("hidden");
        });

        // Submit Formulario
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const data = {
            name: inpName.value,
            description: inpDesc.value,
            price: Number(inpPrice.value),
            stock: Number(inpStock.value),
            category: inpCategory.value,
            image: inpImage.value || "images/default.jpg",
          };

          const id = inpId.value;
          const btnSubmit = form.querySelector("button[type='submit']");
          const originalText = btnSubmit.textContent;
          btnSubmit.disabled = true;
          btnSubmit.textContent = "Guardando...";

          try {
            if (id) {
              // Editar
              await API.updateProduct(id, data);
              alert("Producto actualizado correctamente.");
            } else {
              // Crear
              await API.createProduct(data);
              alert("Producto creado exitosamente.");
            }

            // Volver a la lista
            editView.classList.add("hidden");
            listView.classList.remove("hidden");
            await loadProducts();
          } catch (err) {
            alert("Error al guardar: " + err.message);
          } finally {
            btnSubmit.disabled = false;
            btnSubmit.textContent = originalText;
          }
        });

        // Bot√≥n Clean Abandoned Carts
        btnCleanCarts.addEventListener("click", async () => {
          if (
            confirm(
              "¬øDeseas limpiar todos los carritos abandonados (localStorage)?"
            )
          ) {
            const res = await API.cleanAbandonedCarts();
            alert(res.message);
          }
        });
      });
    </script>
  </body>
</html>
