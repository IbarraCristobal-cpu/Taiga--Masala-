<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finalizar Compra - Malasa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        // Login ahora gestionado por `login_handler.js` (handler centralizado)
       <style>
      :root {
        --color-primario: #ff9933;
        align-items: center;
      }
      .navbar-brand {
        font-family: var(--fuente-titulos);
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--color-texto);
        text-decoration: none;
        display: flex;
        align-items: center;
      }
      .navbar-brand img {
        margin-right: 0.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        object-fit: cover;
      }
      .nav-link {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .form-section h3 {
        font-size: 1.2em;
        margin: 0 0 1em 0;
        color: var(--color-texto);
      }
      .form-section label {
        font-weight: 600;
        display: block;
        margin-bottom: 0.5em;
        font-size: 0.9em;
      }
      .form-section select,
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section textarea {
        width: 100%;
        padding: 0.8em;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1em;
        box-sizing: border-box;
        background-color: #fff;
      }
      .form-row {
        display: flex;
        gap: 1em;
      }
      .form-row .form-field {
        flex: 1;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        margin-top: 1em;
      }
      .checkbox-group input[type="checkbox"] {
        margin-right: 0.5em;
        width: auto;
      }
      .checkbox-group label {
        margin-bottom: 0;
        font-weight: normal;
        font-size: 0.9em;
      }

      .delivery-options label {
        display: inline-block;
        margin-right: 1.5em;
        font-weight: normal;
      }
      .delivery-options input[type="radio"] {
        margin-right: 0.5em;
      }

      .address-section {
        margin-top: 1em;
      }
      .address-new-fields {
        display: flex;
        flex-direction: column;
        gap: 0.8em;
        margin-top: 1em;
      }

      .submit-button {
        width: 100%;
        padding: 1em;
        margin-top: 2em;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 700;
        cursor: pointer;
        background-color: var(--color-accion-primaria);
        color: white;
        transition: transform 0.2s;
      }
      .submit-button:hover {
        transform: scale(1.02);
      }

      
    .modal-card .card-title {
      font-family: "Lora", serif;
      color: #8b4513;
      font-weight: 600;
      font-size: 2em;
      margin-bottom: 1.5em;
    }
    .modal-card .form-floating {
      position: relative;
      margin-bottom: 1.5rem;
      text-align: left;
    }
    .modal-card .form-control {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      box-sizing: border-box;
    }
    .modal-card .btn-primary {
      background-color: #8b4513;
      border: none;
      border-radius: 25px;
      padding: 0.8em;
      font-size: 1.1em;
      font-weight: 600;
      color: white;
      width: 100%;
      cursor: pointer;
      margin-bottom: 1.5em;
    }
    .modal-card .btn-primary:hover {
      background-color: #6a350f;
    }
    .modal-card .register-link a {
      color: #8b4513;
      font-weight: 600;
      text-decoration: none;
    }
  </style>
  <body>
    <nav class="navbar">
      <div class="navbar-container">
        <a class="navbar-brand" href="#">
          <img src="images/Logo/flor.jpg" alt="Logo Masala" />
          Malasa
        </a>
        <ul class="navbar-nav">
          <li><a class="nav-link" href="B07-Home.html">Home</a></li>
          <li><a class="nav-link" href="B04_B05-Catalogo.html">Catálogo</a></li>
          <li>
            <a class="nav-link" href="B06-Formulario_de_Contacto.html"
              >Contacto</a
            >
          </li>

          <!-- Botones Dinámicos (Controlados por menu_logic.js) -->
          <li>
            <a class="nav-link" id="nav-btn-login" href="#">Iniciar Sesión</a>
          </li>

          <!-- Estos están ocultos por defecto (display: none) -->
          <li>
            <a
              class="nav-link"
              id="nav-btn-profile"
              href="B08_B09-Perfil_de_usuario.html"
              style="display: none"
            >
              Mi Perfil</a
            >
          </li>
          <li>
            <a
              class="nav-link"
              id="nav-btn-admin"
              href="B17-Gestion_de_Productos.html"
              style="display: none"
              >Panel Admin</a
            >
          </li>
          <li>
            <a
              class="nav-link"
              id="nav-btn-logout"
              href="B07-Home.html"
              style="display: none"
            >
              Salir</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <main class="checkout-container">
      <h2 class="page-title">Finalizar compra</h2>
      <form id="checkout-form">
        <div
          id="login-modal"
          class="modal-overlay hidden"
          role="dialog"
          aria-modal="true"
        >
          <div class="modal-card">
            <button class="close-modal-btn" aria-label="Cerrar">&times;</button>
            <h3 class="card-title">Iniciar Sesión</h3>
            <form id="login-form">
              <div class="form-floating">
                <input
                  type="email"
                  class="form-control"
                  id="emailLogin"
                  required
                />
                <label for="emailLogin">Correo Electrónico</label>
              </div>
              <div class="form-floating">
                <input
                  type="password"
                  class="form-control"
                  id="passLogin"
                  required
                />
                <label for="passLogin">Contraseña</label>
              </div>
              <a
                href="B03-Recuperar_Contraseña.html"
                class="forgot-password"
                style="
                  display: block;
                  text-align: right;
                  margin-bottom: 1em;
                  color: #8b4513;
                  text-decoration: none;
                "
                >¿Olvidaste tu contraseña?</a
              >
              <button class="btn-primary" type="submit">Ingresar</button>
            </form>
            <div class="register-link">
              <small
                >¿No tienes una cuenta?
                <a href="B01-Formulario_de_registro.html"
                  >Regístrate Aquí</a
                ></small
              >
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>Tipo de Entrega</h3>
          <div class="delivery-options">
            <label>
              <input type="radio" name="deliveryType" value="pickup" checked />
              Servir en Mesa
            </label>
            <label>
              <input type="radio" name="deliveryType" value="delivery" />
              Delivery
            </label>
          </div>
        </div>

        <div id="address-section" class="form-section hidden">
          <h3>Dirección de Envío</h3>
          <div class="address-options">
            <label for="saved-address-select">Usar dirección guardada</label>
            <select id="saved-address-select">
              <option value="">-- Seleccione una dirección --</option>
            </select>
            <p
              style="
                margin: 1em 0 0.5em 0;
                text-align: center;
                color: var(--color-texto-secundario);
              "
            >
              O
            </p>
            <label>Agregar nueva dirección</label>
            <div class="address-new-fields">
              <input
                type="text"
                id="new-address-street"
                placeholder="Calle y Número"
              />
              <input
                type="text"
                id="new-address-details"
                placeholder="Depto / Casa / Oficina (Opcional)"
              />
              <input type="text" id="new-address-city" placeholder="Comuna" />
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>Método de Pago</h3>
          <div class="form-group">
            <label for="saved-cards-select">Usar tarjeta guardada</label>
            <select id="saved-cards-select">
              <option value="">-- Seleccione una tarjeta --</option>
            </select>
          </div>
          <p
            style="
              margin: 1em 0 0.5em 0;
              text-align: center;
              color: var(--color-texto-secundario);
            "
          >
            O
          </p>
          <label>Agregar nueva tarjeta</label>
          <input
            type="text"
            id="card-number"
            placeholder="Número de Tarjeta (XXXX XXXX XXXX XXXX)"
            maxlength="19"
            autocomplete="cc-number"
          />
          <div class="form-row" style="margin-top: 1em">
            <div class="form-field">
              <input
                type="text"
                id="card-expiry"
                placeholder="MM/AA"
                maxlength="5"
                autocomplete="cc-exp"
              />
            </div>
            <div class="form-field">
              <input
                type="text"
                id="card-cvv"
                placeholder="CVV"
                maxlength="4"
                autocomplete="cc-csc"
              />
            </div>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="save-card-checkbox" />
            <label for="save-card-checkbox"
              >Guardar esta tarjeta para futuras compras</label
            >
          </div>
        </div>

        <button type="submit" class="submit-button">Finalizar Compra</button>
      </form>
    </main>

    <script src="api.js"></script>
    <script src="menu_logic.js"></script>
    <script src="login_handler.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        let userProfile = null;
        let savedCards = [];
        let savedAddresses = [];

        const checkoutForm = document.getElementById("checkout-form");
        const deliveryTypeRadios = document.querySelectorAll(
          'input[name="deliveryType"]'
        );
        const addressSection = document.getElementById("address-section");
        const savedCardsSelect = document.getElementById("saved-cards-select");
        const saveCardCheckbox = document.getElementById("save-card-checkbox");
        const cardNumberInput = document.getElementById("card-number");
        const savedAddressSelect = document.getElementById(
          "saved-address-select"
        );

        // Cargar perfil del usuario
        async function loadUserProfile() {
          try {
            const token = localStorage.getItem("authToken");
            if (!token) {
              alert("Necesitas iniciar sesión para continuar");
              window.location.href = "B07-Home.html";
              return;
            }

            userProfile = await API.getMyProfile();
            if (!userProfile) throw new Error("No se pudo cargar el perfil");

            savedCards = userProfile.savedCards || [];
            savedAddresses = userProfile.addresses || [];

            updateDropdowns();
            console.log("Perfil del usuario cargado:", userProfile);
          } catch (error) {
            console.error("Error cargando perfil:", error);
            alert("Error cargando datos. Intenta nuevamente.");
          }
        }

        const renderSavedCardsDropdown = () => {
          savedCardsSelect.innerHTML =
            '<option value="">-- Seleccione una tarjeta guardada --</option>';
          savedCards.forEach((card) => {
            const option = document.createElement("option");
            option.value = card.id;
            option.textContent = `${card.brand || "Tarjeta"} terminada en ${card.last4}`;
            savedCardsSelect.appendChild(option);
          });
        };

        const renderSavedAddressesDropdown = () => {
          savedAddressSelect.innerHTML =
            '<option value="">-- Seleccione una dirección guardada --</option>';
          savedAddresses.forEach((address) => {
            const option = document.createElement("option");
            option.value = address.id;
            option.textContent = address.content;
            savedAddressSelect.appendChild(option);
          });
        };

        const updateDropdowns = () => {
          renderSavedCardsDropdown();
          renderSavedAddressesDropdown();
        };

        deliveryTypeRadios.forEach((radio) => {
          radio.addEventListener("change", (event) => {
            if (event.target.value === "delivery") {
              addressSection.classList.remove("hidden");
            } else {
              addressSection.classList.add("hidden");
            }
          });
        });

        // Procesar Finalizar Compra
        checkoutForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          try {
            // 1. Validar autenticación
            if (!localStorage.getItem("authToken")) {
              alert("Necesitas iniciar sesión para completar la compra");
              return;
            }

            // 2. Obtener datos del formulario
            const deliveryType = document.querySelector(
              'input[name="deliveryType"]:checked'
            ).value;

            let address = null;
            if (deliveryType === "delivery") {
              const selectedAddressId = savedAddressSelect.value;
              const newStreet = document.getElementById("new-address-street")?.value || "";
              const newCity = document.getElementById("new-address-city")?.value || "";

              if (selectedAddressId) {
                const selectedAddr = savedAddresses.find(a => a.id === selectedAddressId);
                address = selectedAddr?.content || null;
              } else if (newStreet && newCity) {
                address = `${newStreet}, ${newCity}`;
              } else {
                alert("Por favor, selecciona o ingresa una dirección de envío");
                return;
              }
            }

            // 3. Obtener tarjeta
            const selectedCardId = savedCardsSelect.value;
            let paymentToken = null;

            if (selectedCardId) {
              const selectedCard = savedCards.find(c => c.id === selectedCardId);
              paymentToken = selectedCard?.token || selectedCardId;
            } else {
              const newCardNumber = cardNumberInput.value.replace(/\s/g, "");
              const cardExpiry = document.getElementById("card-expiry")?.value;
              const cardCvv = document.getElementById("card-cvv")?.value;

              if (newCardNumber.length < 16 || !cardExpiry || !cardCvv) {
                alert("Por favor, ingresa datos válidos de tarjeta");
                return;
              }

              // Generar token simulado para la tarjeta nueva
              paymentToken = `card_${Date.now()}`;
            }

            // 4. Obtener carrito
            const cartItems = JSON.parse(localStorage.getItem("cart") || "[]");
            if (cartItems.length === 0) {
              alert("Tu carrito está vacío");
              return;
            }

            // 5. Obtener código de descuento si existe
            const couponCode = localStorage.getItem("appliedCoupon") || null;

            // 6. Procesar pago
            const btn = checkoutForm.querySelector("button[type='submit']");
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Procesando...";

            const order = await API.placeOrder(
              cartItems,
              couponCode,
              deliveryType,
              address,
              paymentToken,
              saveCardCheckbox.checked
            );

            console.log("Orden creada:", order);

            // 7. Guardar tarjeta si se solicita
            if (saveCardCheckbox.checked && !selectedCardId) {
              const last4 = cardNumberInput.value.replace(/\s/g, "").slice(-4);
              const brand = document.getElementById("card-type")?.value || "Visa";
              try {
                await API.saveCard(paymentToken, last4, brand);
                console.log("Tarjeta guardada");
              } catch (e) {
                console.warn("No se pudo guardar la tarjeta:", e);
              }
            }

            // 8. Limpiar carrito y redirigir
            localStorage.removeItem("cart");
            localStorage.removeItem("appliedCoupon");

            alert(`¡Compra exitosa! Tu orden ID: ${order.id}`);
            window.location.href = "B08_B09-Perfil_de_usuario.html";
          } catch (error) {
            console.error("Error en checkout:", error);
            alert("Error al procesar la compra: " + error.message);
            const btn = checkoutForm.querySelector("button[type='submit']");
            btn.disabled = false;
            btn.textContent = "Finalizar Compra";
          }
        });

        // Auto-formateo de tarjeta
        cardNumberInput.addEventListener("input", (e) => {
          const value = e.target.value.replace(/\D/g, "");
          const groups = value.match(/.{1,4}/g);
          e.target.value = groups ? groups.join(" ").slice(0, 19) : "";
        });

        // Auto-formateo de expiración
        document.getElementById("card-expiry")?.addEventListener("input", (e) => {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 2) {
            value = value.slice(0, 2) + "/" + value.slice(2);
          }
          e.target.value = value.slice(0, 5);
        });

        // Cargar datos del usuario
        await loadUserProfile();
      });

      document.addEventListener("DOMContentLoaded", () => {
        const loginModal = document.getElementById("login-modal");
        const loginNavLink = document.getElementById("nav-btn-login");
        const closeButtons = loginModal
          ? loginModal.querySelectorAll(".close-modal-btn")
          : [];

        const openModal = () => {
          if (loginModal) loginModal.classList.remove("hidden");
        };
        const closeModal = () => {
          if (loginModal) loginModal.classList.add("hidden");
        };

        if (loginNavLink)
          loginNavLink.addEventListener("click", (e) => {
            e.preventDefault();
            openModal();
          });
        closeButtons.forEach((btn) =>
          btn.addEventListener("click", closeModal)
        );
        if (loginModal)
          loginModal.addEventListener("click", (e) => {
            if (e.target === loginModal) closeModal();
          });

        // Login ahora gestionado por `login_handler.js`
      });
    </script>
  </body>
</html>
