<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Men칰 - Malasa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Open+Sans:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-primario: #ff9933;
        --color-secundario: #8b4513;
        --color-fondo-pagina: #fdfaf5;
        --color-surface: #ffffff;
        --color-texto: #4a2e2a;
        --color-texto-secundario: #6c757d;
        --color-borde-ligero: #eee;
        --fuente-titulos: "Lora", serif;
        --fuente-cuerpo: "Open Sans", sans-serif;
      }

      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        font-family: var(--fuente-cuerpo);
        background-color: var(--color-fondo-pagina);
        color: var(--color-texto);
      }
      .navbar-container {
        width: 100%;
        max-width: 1140px;
        margin: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .navbar-brand {
        font-family: var(--fuente-titulos);
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--color-texto);
        text-decoration: none;
        display: flex;
        align-items: center;
      }
      .navbar-brand img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 0.5rem;
      }
      .navbar-nav {
        list-style: none;
        display: flex;
        gap: 1.5rem;
        margin: 0;
      }
      .nav-link {
        color: var(--color-texto);
        text-decoration: none;
        font-weight: 600;
      }
      .nav-link.active,
      .nav-link:hover {
        color: var(--color-primario);
      }
      #nav-btn-admin {
        color: #d32f2f;
      }

      .main-container {
        flex-grow: 1;
        width: 100%;
        max-width: 1200px;
        margin: 2em auto;
        padding: 0 1em;
        display: flex;
        gap: 2em;
      }

      .sidebar {
        width: 25%;
        flex-shrink: 0;
      }
      .sidebar h2 {
        font-family: var(--fuente-titulos);
        color: var(--color-secundario);
        margin-top: 0;
      }
      .search-group {
        display: flex;
        margin-bottom: 1.5em;
      }
      .search-group input {
        flex-grow: 1;
        padding: 0.8em;
        border: 1px solid #ccc;
        background-color: var(--color-surface);
        color: var(--color-texto);
        border-radius: 5px 0 0 5px;
      }
      .search-group input:focus {
        outline: none;
        border-color: var(--color-primario);
      }
      .search-group button {
        border: 1px solid #ccc;
        background-color: var(--color-secundario);
        color: white;
        padding: 0 1em;
        border-radius: 0 5px 5px 0;
        cursor: pointer;
        border-left: none;
      }
      .category-nav {
        list-style: none;
        padding: 0;
        margin-top: 1.5em;
      }
      .category-nav a {
        display: block;
        padding: 0.8em 1em;
        color: var(--color-texto);
        text-decoration: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .category-nav a:hover {
        background-color: var(--color-fondo-pagina);
      }
      .category-nav a.active {
        background-color: var(--color-secundario);
        color: white;
        font-weight: 600;
      }

      /* Secci칩n Carrito */
      .sidebar-cart {
        background-color: var(--color-surface);
        padding: 1em;
        border-radius: 8px;
        margin-top: 1.5em;
        text-align: center;
        border: 1px solid var(--color-borde-ligero);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .sidebar-cart p {
        margin: 0 0 0.8em 0;
        font-weight: 600;
      }
      .sidebar-cart .cart-link-btn {
        display: inline-block;
        background-color: var(--color-primario);
        color: var(--color-secundario);
        padding: 0.6em 1.5em;
        text-decoration: none;
        font-weight: 700;
        border-radius: 20px;
        font-size: 0.9em;
        border: none;
        cursor: pointer;
      }

      .product-catalog {
        width: 75%;
      }
      .category-title {
        font-family: var(--fuente-titulos);
        margin-bottom: 1em;
        color: var(--color-secundario);
      }
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.5em;
      }
      .product-card {
        background-color: var(--color-surface);
        border: 1px solid var(--color-borde-ligero);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }
      .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .product-card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }
      .card-body {
        padding: 1em;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      .card-title {
        font-family: var(--fuente-titulos);
        margin: 0 0 0.2em 0;
        font-size: 1.1em;
      }
      .card-price {
        color: var(--color-secundario);
        font-size: 1.1em;
        margin-bottom: 0.5em;
        font-weight: 600;
      }
      .card-description {
        font-size: 0.85em;
        color: var(--color-texto-secundario);
        flex-grow: 1;
        margin-bottom: 1em;
      }
      .product-actions {
        margin-top: auto;
      }
      .quantity-selector {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--color-fondo-pagina);
        border-radius: 20px;
        padding: 0.3em;
        border: 1px solid var(--color-borde-ligero);
      }
      .quantity-btn {
        background-color: var(--color-primario);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 1.5em;
        line-height: 1;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .quantity-count {
        font-size: 1.1em;
        font-weight: 700;
        color: var(--color-texto);
      }

      .footer {
        flex-shrink: 0;
        background-color: var(--color-secundario);
        text-align: center;
        padding: 1rem 1rem;
        margin-top: 3em;
        color: white;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--color-primario);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 50px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Modales importados */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s;
      }
      .modal-overlay.hidden {
        opacity: 0;
        visibility: hidden;
      }
      .modal-card {
        background-color: #fff8e1;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        padding: 2.5em;
        text-align: center;
        position: relative;
      }
      .close-modal-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2rem;
        background: none;
        border: none;
        cursor: pointer;
      }
      .modal-card .form-control {
        width: 100%;
        padding: 1rem;
        margin-bottom: 1em;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .modal-card .btn-primary {
        width: 100%;
        padding: 0.8em;
        background: #8b4513;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <nav class="navbar">
      <div class="navbar-container">
        <a class="navbar-brand" href="#">
          <img src="images/Logo/flor.jpg" alt="Logo Masala" />
          Malasa
        </a>
        <ul class="navbar-nav">
          <li><a class="nav-link" href="B07-Home.html">Home</a></li>
          <li>
            <a class="nav-link active" href="B04_B05-Catalogo.html">Cat치logo</a>
          </li>
          <li>
            <a class="nav-link" href="B06-Formulario_de_Contacto.html"
              >Contacto</a
            >
          </li>
          <li>
            <a class="nav-link" id="nav-btn-login" href="#">Iniciar Sesi칩n</a>
          </li>
          <li>
            <a
              class="nav-link"
              id="nav-btn-profile"
              href="B08_B09-Perfil_de_usuario.html"
              style="display: none"
              >Mi Perfil</a
            >
          </li>
          <li>
            <a
              class="nav-link"
              id="nav-btn-admin"
              href="B17-Gestion_de_Productos.html"
              style="display: none"
              >Panel Admin</a
            >
          </li>
          <li>
            <a
              class="nav-link"
              id="nav-btn-logout"
              href="B07-Home.html"
              style="display: none"
              >Salir</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <div class="main-container">
      <aside class="sidebar">
        <h2>Men칰</h2>
        <div class="search-group">
          <input
            type="text"
            id="search-input"
            placeholder="쯈u칠 quieres pedir?"
          />
          <button id="search-btn">游댌</button>
        </div>

        <div class="sidebar-cart">
          <p>游 Carrito: <span id="cart-count">0</span> items</p>
          <a href="B10_B11-Carrito_y_Descuentos.html" class="cart-link-btn"
            >Ver Carrito</a
          >
        </div>
        <ul class="category-nav" id="category-nav">
          <li>
            <a class="category-link active" data-category="Todos"
              >Todos los Platos</a
            >
          </li>
          <li>
            <a class="category-link" data-category="Entradas"
              >Chatpati - Entradas</a
            >
          </li>
          <li>
            <a class="category-link" data-category="Platos Principales"
              >Platos Principales</a
            >
          </li>
          <li>
            <a class="category-link" data-category="Postres"
              >Mithai - Postres</a
            >
          </li>
          <li>
            <a class="category-link" data-category="Jugos">Jugos Naturales</a>
          </li>
        </ul>
      </aside>

      <main class="product-catalog">
        <h3 id="category-title" class="category-title">Todos los Platos</h3>
        <div id="loader" class="loader"></div>
        <div id="product-grid" class="product-grid"></div>
      </main>
    </div>

    <footer class="footer">
      <p>춸 2024 Restaurante Malasa. Todos los derechos reservados.</p>
    </footer>

    <!-- MODAL DE LOGIN REUTILIZABLE -->
    <div id="login-modal" class="modal-overlay hidden">
      <div class="modal-card">
        <button class="close-modal-btn">&times;</button>
        <h3 style="color: #8b4513; margin-bottom: 1em">Iniciar Sesi칩n</h3>
        <form id="login-form">
          <input
            type="email"
            class="form-control"
            id="emailLogin"
            required
            placeholder="Correo Electr칩nico"
          />
          <input
            type="password"
            class="form-control"
            id="passLogin"
            required
            placeholder="Contrase침a"
          />
          <a
            href="B03-Recuperar_Contrase침a.html"
            style="
              display: block;
              text-align: right;
              margin-bottom: 1em;
              color: #8b4513;
            "
            >쯆lvidaste tu contrase침a?</a
          >
          <button class="btn-primary" type="submit">Ingresar</button>
        </form>
        <div style="margin-top: 1em">
          <small
            >쯅o tienes una cuenta?
            <a href="B01-Formulario_de_registro.html" style="color: #8b4513"
              >Reg칤strate Aqu칤</a
            ></small
          >
        </div>
      </div>
    </div>

    <script src="api.js"></script>
    <script src="menu_logic.js"></script>
    <script src="login_handler.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // --- ESTADO Y VARIABLES ---
        let allProducts = [];
        let totalCartItems = 0;

        const productGrid = document.getElementById("product-grid");
        const categoryNav = document.getElementById("category-nav");
        const categoryTitle = document.getElementById("category-title");
        const cartCountElement = document.getElementById("cart-count");
        const loader = document.getElementById("loader");
        const searchInput = document.getElementById("search-input");
        const searchBtn = document.getElementById("search-btn");

        // --- INICIALIZAR ---
        await loadProducts();
        updateCartCount();

        // --- FUNCIONES ---

        async function loadProducts() {
          loader.style.display = "block";
          productGrid.innerHTML = "";
          try {
            // Obtener datos reales de la API (sincronizados con Admin)
            allProducts = await API.getProducts();
            renderProducts("Todos");
          } catch (error) {
            productGrid.innerHTML =
              "<p>Error cargando el men칰. Intente m치s tarde.</p>";
            console.error(error);
          } finally {
            loader.style.display = "none";
          }
        }

        function renderProducts(filterCategory) {
          productGrid.innerHTML = "";
          let filtered = allProducts;

          if (filterCategory !== "Todos") {
            filtered = allProducts.filter((p) => p.category === filterCategory);
          }

          if (filtered.length === 0) {
            productGrid.innerHTML =
              "<p>No se encontraron productos en esta categor칤a.</p>";
            return;
          }

          filtered.forEach((product) => {
            // Formato de precio chileno
            const priceFmt = new Intl.NumberFormat("es-CL", {
              style: "currency",
              currency: "CLP",
            }).format(product.price);

            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/200?text=Sin+Imagen'">
                    <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-price">${priceFmt}</p>
                        <p class="card-description">${product.description}</p>
                        <div class="product-actions">
                            <div class="quantity-selector">
                                <button class="quantity-btn" onclick="updateCartItem(${product.id}, -1)">-</button>
                                <span class="quantity-count" id="qty-${product.id}">0</span>
                                <button class="quantity-btn" onclick="updateCartItem(${product.id}, 1)">+</button>
                            </div>
                        </div>
                    </div>`;
            productGrid.appendChild(card);
          });
          // Restaurar cantidades si ya hay algo en el carrito
          syncQuantities();
        }

        function updateCartCount() {
          // Calcular total de items en el carrito local
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");
          totalCartItems = cart.reduce((sum, item) => sum + item.quantity, 0);
          if (cartCountElement) cartCountElement.textContent = totalCartItems;
        }

        function syncQuantities() {
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");
          cart.forEach((item) => {
            const qtySpan = document.getElementById(`qty-${item.productId}`);
            if (qtySpan) qtySpan.textContent = item.quantity;
          });
        }

        // --- EXPORTAR FUNCI칍N GLOBAL PARA BOTONES ---
        window.updateCartItem = (productId, change) => {
          let cart = JSON.parse(localStorage.getItem("cart") || "[]");
          const existingItem = cart.find((i) => i.productId === productId);
          const qtySpan = document.getElementById(`qty-${productId}`);

          if (existingItem) {
            existingItem.quantity += change;
            if (existingItem.quantity <= 0) {
              cart = cart.filter((i) => i.productId !== productId);
              if (qtySpan) qtySpan.textContent = 0;
            } else {
              if (qtySpan) qtySpan.textContent = existingItem.quantity;
            }
          } else if (change > 0) {
            cart.push({ productId, quantity: 1 });
            if (qtySpan) qtySpan.textContent = 1;
          }

          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartCount();
        };

        // --- EVENT LISTENERS ---

        // 1. Navegaci칩n Categor칤as
        categoryNav.addEventListener("click", (event) => {
          if (event.target.classList.contains("category-link")) {
            // UI Update
            document
              .querySelectorAll(".category-link")
              .forEach((l) => l.classList.remove("active"));
            event.target.classList.add("active");

            // Logic
            const cat = event.target.dataset.category;
            categoryTitle.textContent = event.target.textContent;
            renderProducts(cat);
          }
        });

        // 2. Buscador
        searchBtn.addEventListener("click", () => {
          const term = searchInput.value.toLowerCase();
          const results = allProducts.filter((p) =>
            p.name.toLowerCase().includes(term)
          );

          // Render manual de resultados de b칰squeda
          productGrid.innerHTML = "";
          categoryTitle.textContent = `Resultados para "${term}"`;

          if (results.length === 0) {
            productGrid.innerHTML = "<p>No se encontraron productos.</p>";
            return;
          }

          // Reutilizamos l칩gica de renderizado parcial
          // Truco: filtrar allProducts temporalmente solo para usar renderProducts es complejo,
          // mejor renderear directamente aqu칤 o adaptar renderProducts.
          // Para simplicidad, filtramos visualmente:
          const prevAll = [...allProducts]; // backup
          allProducts = results; // temporal replace
          renderProducts("Todos");
          allProducts = prevAll; // restore
        });

        // 3. Login Modal (L칩gica simple)
        const loginBtn = document.getElementById("nav-btn-login");
        const loginModal = document.getElementById("login-modal");
        const closeBtns = document.querySelectorAll(".close-modal-btn");

        if (loginBtn) {
          loginBtn.addEventListener("click", (e) => {
            e.preventDefault();
            loginModal.classList.remove("hidden");
          });
        }
        closeBtns.forEach((btn) =>
          btn.addEventListener("click", () => {
            loginModal.classList.add("hidden");
          })
        );

        // Login ahora gestionado por `login_handler.js` (handler centralizado)
      });
    </script>
  </body>
</html>
